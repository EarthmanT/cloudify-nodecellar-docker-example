tosca_definitions_version: cloudify_dsl_1_0

imports:
  - http://www.getcloudify.org/spec/cloudify/3.2m4/types.yaml
  - http://www.getcloudify.org/spec/docker-plugin/1.2m4/plugin.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/1.2m4/plugin.yaml

inputs:
  image:
    description: >
      The OpenStack image ID 
    default: 8c096c29-a666-4b82-99c4-c77dc70cfb40

  flavor:
    description: >
      The OpenStack flavor
    default: 102

  agent_user:
    description: >
      User name used when SSH-ing into the started machine
    default: ubuntu

  web_port:
    description: >
      Which port you want to map the web port to.
    default: 8080

  mongo_port:
    description: >
      Which port you want to map the mongo port to.
    default: 27017
    
  web_status_port:
    description: >
      Which port for the mongo web status page.
    default: 28017

node_templates:
  vm:
    type: cloudify.openstack.nodes.Server
    properties:
      cloudify_agent:
          user: { get_input: agent_user }
          home_dir: /home/ubuntu
      server:
          image: { get_input: image }
          flavor: { get_input: flavor }

    relationships:
      - target: nodecellar_security_group
        type: cloudify.openstack.server_connected_to_security_group
      - target: mongod_security_group
        type: cloudify.openstack.server_connected_to_security_group
      - target: nodecellar_floatingip
        type: cloudify.openstack.server_connected_to_floating_ip

  nodecellar_container:
    type: cloudify.docker.Container
    properties:
      name: nodecellar
      image:
        repository: uric/nodecellar
      ports:
        8080: { get_input: web_port }
      params:
        stdin_open: true
        tty: true
        command: nodejs server.js
        environment:
          NODECELLAR_PORT: { get_input: web_port }
          MONGO_PORT: { get_input: mongo_port }
    relationships:
      - type: cloudify.relationships.contained_in
        target: vm
      - type: cloudify.relationships.connected_to
        target: mongod_container
        source_interfaces:
          cloudify.interfaces.relationship_lifecycle:
            preconfigure: nodecellar-scripts/preconfigure.py

  mongod_container:
    type: cloudify.docker.Container
    properties:
      name: mongod
      image:
        repository: dockerfile/mongodb
      ports:
        27017: { get_input: mongo_port }
        28017: { get_input: web_status_port }
      params:
        stdin_open: true
        tty: true
        command: mongod --rest --httpinterface --smallfiles
    relationships:
      - type: cloudify.relationships.contained_in
        target: vm

  nodecellar_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: nodecellar-security-group-docker
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_input: web_port }
        - remote_ip_prefix: 0.0.0.0/0
          port: 22
    relationships:
      - type: cloudify.relationships.connected_to
        target: mongod_security_group

  mongod_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: mongod-security-group-docker
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_input: mongo_port }
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_input: web_status_port }
        - remote_ip_prefix: 0.0.0.0/0
          port: 22

  nodecellar_floatingip:
    type: cloudify.openstack.nodes.FloatingIP

outputs:
  endpoint:
    description: Web application endpoint
    value:
      ip_address: { get_attribute: [ nodecellar_floatingip, floating_ip_address ] }
      port: { get_input: web_port }
